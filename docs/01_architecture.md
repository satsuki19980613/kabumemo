# アプリケーションアーキテクチャ (01_architecture.md)

## 1. コンセプト概要

本アプリケーション「株メモ」は、個人投資家が自身の投資判断を補助するための、パーソナルな情報蓄積・整理ツールである。株式市場に関する多様な情報を「ファクター」として記録・管理し、ユーザー独自の「投資判断データベース」を構築することを目的とする。開発ターゲットは **Android** と **iOS** の両ネイティブアプリケーションである。

---

## 2. 技術スタック (Technical Stack)

コンセプトに基づき、効率的なマルチプラットフォーム開発と安定したバックエンド運用を実現するため、以下の技術構成を採用する。

- **クロスプラットフォームフレームワーク**: **Kotlin Multiplatform (KMP)**
    - ビジネスロジックを共通化し、UIも **Compose Multiplatform** を用いて単一コードベースでiOSとAndroidの両アプリを構築する。
- **バックエンド (BaaS)**: **Firebase**
    - **データベース**: **Firestore** を採用し、ファクターやユーザー情報を格納する。リアルタイム同期機能に加え、**永続キャッシュ (persistent cache) を有効化**し、堅牢なオフラインサポートを実現する。
    - **認証**: **Firebase Authentication** を利用し、メールアドレスやGoogleアカウントによるユーザー認証機能を提供する。
    - **ストレージ**: **Cloud Storage for Firebase** を利用し、ファクターに添付される画像ファイルを保存・管理する。
- **外部サービス連携**:
    - **銘柄情報取得: 金融庁が提供する EDINET API を利用し、銘柄情報の検索機能を実現する。**

---

## 3. モックアップ概要

提供されたHTML、CSS、JavaScriptファイル群は、KMPによるネイティブアプリケーション開発の **視覚的な仕様書（Visual Specification）** として機能する、高忠実度のプロトタイプである。このモックアップは、完成形のアプリが持つべき画面構造、コンポーネントデザイン、そしてユーザーインタラクションを定義している。
---

## 4. フロントエンドアーキテクチャ (モックアップ基準)

### 4.1. ~ 4.4.

(4.1. ~ 4.4.のセクションは変更なし)

### 4.5. オフラインアーキテクチャ (Offline Architecture)

本アプリは、Firestore SDKが提供する永続キャッシュ機能を利用し、「オフラインファースト」の思想で設計される。

- **データ永続化**: Firestoreの永続キャッシュを有効にすることで、一度取得したデータはデバイスのローカルストレージに安全に保存される。
- **オフライン時の読み取り**: ネットワークがオフラインの場合、アプリケーションはFirestoreサーバーへの接続を試みず、ローカルキャッシュから直接データを読み取る。これにより、通信環境に依存しない高速なデータ表示を実現する。
- **オフライン時の書き込み**: オフライン中に行われたファクターの新規作成、編集、削除の操作は、SDK内の書き込みキューに一時的に保存される。UIは即座に更新され、ユーザーは操作が完了したかのように感じる。
- **自動同期**: ネットワーク接続が復帰すると、SDKはバックグラウンドで自動的にキュー内の変更をFirestoreサーバーに送信する。同時に、サーバー上の他のデバイスによる変更もローカルキャッシュに同期する。
- **競合の解決**: 万が一、複数デバイスで同じドキュメントがオフライン中に編集された場合でも、Firestoreのデフォルトの競合解決戦略（最後に書き込んだものが優先される）によりデータの一貫性が保たれる。

---

## 5. データフロー (概念)

本アプリケーションにおけるデータの流れは、オフラインアーキテクチャを前提とする。

1. **入力**: ユーザーが投稿モーダル (`modal-post`) を通じてファクター（テキスト、画像、センチメント等）を入力する。
2. **クライアント処理 (オフライン)**: KMPの共有ロジックが入力データを受け取り、**ローカルのFirestoreキャッシュ**に書き込む。UIはキャッシュの変更を即座に反映するため、ユーザーは遅延なく操作結果を確認できる。
3. **バックエンド連携 (自動同期)**:
    - デバイスがオンラインの場合、Firebase SDKがバックグラウンドでローカルキャッシュの変更を **Firestoreサーバー**に自動的に同期する。
    - 画像ファイルは **Cloud Storage** にアップロードされ、そのURLがFirestoreのドキュメントに紐付けられる。この処理もオフラインキューイングに対応する。
4. **表示**: 各画面（ホーム、カレンダー等）は、常に**ローカルのFirestoreキャッシュ**をデータソースとして監視する。これにより、オフライン時でも常にデータを表示でき、オンライン復帰時にはサーバーからの変更が自動的にUIに反映される。

---


## 6. まとめ

提供されたモックアップ群は、コンセプトで定義された要件を高い解像度で具現化した設計図である。コンポーネントベースで疎結合なアーキテクチャは、Kotlin Multiplatformを用いたアジャイルなネイティブアプリ開発の強固な基盤となる。